#!/bin/python3      
import os
import sys

script_dir = os.path.dirname(os.path.realpath(__file__))
sys.path.append(script_dir)

import numpy as np
import rospy
from cv_project.msg import setpoint, robotState, robotMeasurement
from utils.math_utils import *

def in_fixed_pose(point, quat):
    
    msg = setpoint()
    msg.end_pos.x = point[0]
    msg.end_pos.y = point[1]
    msg.end_pos.z = point[2]
    
    msg.end_quat.w = quat[0]
    msg.end_quat.x = quat[1]
    msg.end_quat.y = quat[2]
    msg.end_quat.z = quat[3]
    
    msg.end_vel.x = 0
    msg.end_vel.y = 0
    msg.end_vel.z = 0
    
    msg.end_w.x = 0
    msg.end_w.y = 0
    msg.end_w.z = 0
    
    return msg

    
class StateSubscriber:
    def __init__(self, agent_ID):
        self.latest_msg = robotState()
        self.initial_msg = robotState()
        self.latest_msg.header.stamp.from_sec(0.0)
        
        sub_topic_name = "/simulator/state_"+str(agent_ID)
        self.sub = rospy.Subscriber(sub_topic_name, robotState, self.callback)
        
    def callback(self, msg):            
        self.latest_msg = msg

    def get_state(self):
        return self.latest_msg
    
    def get_initial_state(self):
        return self.initial_msg
    


def run():
    try:
        rospy.init_node("trajectory_generator")
        agent_ID = rospy.get_param("~agent_id")
        pub_topic_name = "/robot_" + str(agent_ID) + "/trajectory_generator/setpoint"
        pub = rospy.Publisher(pub_topic_name, setpoint, queue_size=10)
        state_sub = StateSubscriber(agent_ID)
        rate = rospy.Rate(10)
        
        while not rospy.is_shutdown():  
            time = state_sub.latest_msg.header.stamp.to_sec()

            if time < 3:    
                phase_flag = 1      
                i_points = np.array([[0.9, 0.9, 0.2],
                        [0.9, -0.9, 0.2],
                        [-0.9, -0.9, 0.2],
                        [-0.9, 0.9, 0.2]])
                i_eulers=np.array([[np.pi*3/4, 0, 0],
                    [np.pi/4, 0, 0],
                    [-np.pi/4, 0, 0],
                    [-np.pi*3/4, 0, 0]])
                
                f_points = i_points
                f_eulers = i_eulers
                i_time = 0
                f_time = 5
            elif time < 10:
                if phase_flag == 1:
                    i_points = f_points
                    i_eulers = f_eulers
                    i_time = f_time
                    phase_flag = 2   
                f_points = np.array([[0.9, 0.0, 0.7],
                        [0.0, -0.9, 0.7],
                        [-0.9, 0.0, 0.7],
                        [0.0, 0.9, 0.7]])
                f_eulers = np.array([[np.pi/2, np.pi/6, 0],
                    [0, np.pi/6, 0],
                    [-np.pi/2, np.pi/6, 0],
                    [-np.pi, np.pi/6, 0]])
                f_time = 10
            elif time < 20:
                if phase_flag == 2:
                    i_points = f_points
                    i_eulers = f_eulers
                    i_time = f_time
                    phase_flag = 3
                f_points = np.array([[0.4, 0.3, 1.0],
                        [-0.3, -0.4, 1.0],
                        [-0.4, -0.3, 1.0],
                        [0.3, 0.4, 1.0]])
                f_eulers = np.array([[np.pi/2, 0, 0],
                    [0, 0, 0],
                    [-np.pi/2, 0, 0],
                    [-np.pi, 0, 0]])
                f_time = 20
            elif time < 30:
                if phase_flag == 3:
                    i_points = f_points
                    i_eulers = f_eulers
                    i_time = f_time
                    phase_flag = 4
                # f_points = np.array([[0.6, 0.1, 1.0],
                #         [-0.1, -0.6, 1.0],
                #         [-0.6, -0.1, 1.0],
                #         [0.1, 0.6, 1.0]])
                # f_eulers = np.array([[np.pi/2, 0, 0],
                #     [0, 0, 0],
                #     [-np.pi/2, 0, 0],
                #     [-np.pi, 0, 0]])
                f_points = np.array([[0.4, -0.3, 1.2],
                        [0.3, -0.4, 1.2],
                        [-0.4, 0.3, 1.2],
                        [-0.3, 0.4, 1.2]])
                f_eulers=np.array([[np.pi*3/4, 0, 0],
                    [np.pi/4, 0, 0],
                    [-np.pi/4, 0, 0],
                    [-np.pi*3/4, 0, 0]])
                f_time = 30
            elif time < 40:
                if phase_flag == 4:
                    i_points = f_points
                    i_eulers = f_eulers
                    i_time = f_time
                    phase_flag = 5
                f_points = np.array([[0.2, 0.1, 1.2],
                        [-0.1, -0.2, 1.2],
                        [-0.2, -0.1, 1.2],
                        [0.1, 0.2, 1.2]])
                f_eulers = np.array([[np.pi/2, 0, 0],
                    [0, 0, 0],
                    [-np.pi/2, 0, 0],
                    [-np.pi, 0, 0]])
                f_time = 40
            else:
                if phase_flag == 5:
                    i_points = f_points
                    i_eulers = f_eulers
                    i_time = f_time
                    phase_flag = 6
                # f_points = np.array([[0.9, 0.0, 0.7],
                #         [0.0, -0.9, 0.7],
                #         [-0.9, 0.0, 0.7],
                #         [0.0, 0.9, 0.7]])
                # f_eulers= np.array([[np.pi/2, np.pi/6, 0],
                #     [0, np.pi/6, 0],
                #     [-np.pi/2, np.pi/6, 0],
                #     [-np.pi, np.pi/6, 0]])
                
                f_time = 50

            points = (f_points - i_points)*max((time-i_time)/(f_time-i_time), 1) + i_points
            eulers = (f_eulers - i_eulers)*max((time-i_time)/(f_time-i_time), 1) + i_eulers

            msg = in_fixed_pose(points[agent_ID], zyx_euler_to_quat(eulers[agent_ID], in_degree=False))
            
            pub.publish(msg)
            rate.sleep()
        
    except rospy.ROSException:
        pass

if __name__ == '__main__':
    run()