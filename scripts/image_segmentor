#!/bin/python3
import os
import sys

script_dir = os.path.dirname(os.path.realpath(__file__))
sys.path.append(script_dir)

import numpy as np
import rospy
from cv_project.msg import clothMask
from utils.math_utils import *
from std_msgs.msg import *
from sensor_msgs.msg import Image
from cv_bridge import CvBridge
from ultralytics import YOLO
import cv2
import torch

# Image segementation node - by YOLOv8
    
class ImageSegmentor:
    def __init__(self):
        self.bridge = CvBridge()
        rospy.init_node("segmentor")
        agent_num = rospy.get_param("~agent_num")
        model_dir = rospy.get_param("~model_dir")
        self.init_segmentor_by_params(agent_num, model_dir)
        init_pub = rospy.Publisher("~initialized", Bool, queue_size=2, latch=True)
        init_pub.publish(data=True)
        
    def init_segmentor_by_params(self, agent_num, model_dir):
        self.model:YOLO = YOLO(model_dir)
        if(torch.cuda.is_available()):
            self.model.to("cuda")
            print("YOLO model set to cuda")
        self.agent_num = agent_num
        self.img_sub = []
        self.mask_pub = []
        
        for i in range(agent_num):
            self.img_sub.append(ViewSubscriber(i, self))
            self.mask_pub.append(MaskPublisher(i))
        
        # for test
        self.seg_vis_pub = rospy.Publisher("~seg_vis", Image, queue_size=3)
        
    def mask_to_msg(self, binary_mask: np.ndarray, header=None, encoding="mono8") -> clothMask:
        msg = clothMask()
        
        if header is not None:
            msg.header = header
        else:
            msg.header.stamp = rospy.Time.now()
            msg.header.frame_id = "camera_frame"

        if len(binary_mask.shape) == 3 and binary_mask.shape[2] == 1:
            binary_mask = binary_mask.squeeze(axis=2)

        msg.height, msg.width = binary_mask.shape
        msg.data = binary_mask.astype(np.uint8).flatten().tolist()
        msg.encoding = encoding
        return msg
            
    def segment_image(self, image_msg:Image, agent_ID):   # called by the callback of ViewSubscribers
        # segment image
        img = self.bridge.imgmsg_to_cv2(image_msg) # BGR image
        results = self.model(img, verbose=False)[0]
        if results.masks is not None and results.masks.data is not None:
            data = np.any(results.masks.data.cpu().numpy(), axis=0).astype(np.uint8)
        else:
            H, W = img.shape[:2]
            data = np.zeros((H,W), dtype=np.uint8)
            
        # store result to publisher
        msg = self.mask_to_msg(data, image_msg.header)
        self.mask_pub[agent_ID].update_msg(msg)
    
        # publish data 
        self.mask_pub[agent_ID].pub()
    
        # segmentation test
        if agent_ID == 0:
            self.seg_vis_pub.publish(self.bridge.cv2_to_imgmsg(255 * data, encoding="mono8"))
        
class ViewSubscriber:
    def __init__(self, agent_ID, parent_segmentor:ImageSegmentor=None):
        self.last_msg = Image()
        self.parent = parent_segmentor  # assign member
        self.agent_ID = agent_ID
        self.sub_topic_name = "simulator/view_" + str(agent_ID)
        self.subscriber = rospy.Subscriber(self.sub_topic_name, Image, self.callback)
        
    def callback(self, msg):
        # self.last_msg = msg
        if self.parent is not None:
            self.parent.segment_image(msg, self.agent_ID)
    
class MaskPublisher:
    def __init__(self, agent_ID):
        self.last_msg = clothMask()
        self.agent_ID = agent_ID
        self.topic_name = "~cloth_mask_" + str(agent_ID)
        self.publisher = rospy.Publisher(self.topic_name, clothMask, queue_size=5)
        pass
    
    def update_msg(self, msg:clothMask):
        self.last_msg = msg
    
    def pub(self):
        self.publisher.publish(self.last_msg)
    

if __name__ == '__main__':
    segmentor = ImageSegmentor()
    rospy.spin()